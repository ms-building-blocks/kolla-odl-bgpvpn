---

- name: Install pip
  become: True
  yum:
    name: python-pip

- name: clone kolla-ansible repository
  git:
    repo: https://github.com/openstack/kolla-ansible
    dest: "{{ tmp_dir }}/kolla-ansible"

- name: fetch ODL change
  shell: "git fetch https://git.openstack.org/openstack/kolla-ansible {{ kolla_odl_git_refs }} && git checkout FETCH_HEAD"
  args:
    chdir: "{{ tmp_dir }}/kolla-ansible"

- name: Install kolla-ansible
  become: True
  pip:
    name: "file://{{ tmp_dir }}/kolla-ansible"

- name: Copy the configuration files globals.yml and passwords.yml to /etc directory
  become: True
  command: cp -r {{ tmp_dir }}/kolla-ansible/etc/kolla /etc/kolla/

#- name: Copy the inventory file
#  command: "cp {{ tmp_dir }}/kolla-ansible/ansible/inventory/multinode {{ kolla_node_home_dir }}"

- name: Override globals.yml options
  become: True
  lineinfile:
    path: /etc/kolla/globals.yml
    regexp: "{{ item.key }}:"
    line: "{{ item.key }}: \"{{ item.value }}\""
    create: yes
    state: present
  with_dict: "{{ globals_override }}"

- name: Generate random passwords
  become: True
  command: kolla-genpwd

- name: Override passwords
  become: True
  lineinfile:
    path: /etc/kolla/passwords.yml
    regexp: "{{ item.key }}"
    line: "{{ item.key }}: {{ item.value }}"
  with_dict: "{{ password_overrides }}"
  when: password_overrides is defined

- name: Create multinode inventory file
  template:
    src: "multinode.j2"
    dest: "{{ kolla_node_home_dir }}/multinode"


- name: Create opnfv-quagga directory structure
  become: True
  file:
    path: "/usr/share/kolla-ansible/ansible/roles/opnfv-quagga/{{ item.name }}"
    state: directory
  with_items: "{{ quagga_files }}"
  when: quagga_files is defined

- name: Add opnfv-quagga role files
  become: True
  copy:
    src: "./files/quagga-{{ item.0.name }}-{{ item.1 }}"
    dest: "/usr/share/kolla-ansible/ansible/roles/opnfv-quagga/{{ item.0.name }}/{{ item.1 }}"
  with_subelements:
    - "{{ quagga_files }}"
    - files
  when: quagga_files is defined

- name: Add opnfv-quagga role to site.yml
  become: True
  blockinfile:
    path: "/usr/share/kolla-ansible/ansible/site.yml"
    block: |
      - name: Apply quagga role
        gather_facts: false
        hosts: quagga
        roles:
          - { role: opnfv-quagga,
              tags: opnfv-quagga }
  when: quagga_files is defined

- name: Kolla prechecks
  command: "kolla-ansible prechecks -i {{ kolla_node_home_dir }}/multinode"
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False

- name: Kolla deploy
  command: "kolla-ansible deploy -i {{ kolla_node_home_dir }}/multinode"
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False

#- name: limit CPU of quagga container
#  become: True
#  docker_container:
#    name: quagga
#    state: started
#    cpu_period: 100000
#    cpu_quota: 10000
#    image: 172.26.0.1:5000/kolla/centos-source-opnfv-quagga:5.0.0

#- name: Kolla post-deploy
#  command: "kolla-ansible deploy"
